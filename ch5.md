# 第5章 数据复制

[TOC]

## 5.1 名词解释

**副本**：每个保存数据库完整数据集的节点称之为副本。

**主副本**：也称为主节点。

**从副本**：也称为从节点。

## 5.2 数据复制是什么

复制主要指通过互联网络在多台机器上保存相同数据的副本。

数据库复制是个**古老的话题**。因为网络的基本约束条件没有发生质的改变，可以说自1970年来所研究的基本复制原则，时至今日也没有发生太大的变化。

## 5.3 为什么要数据复制（复制的目的）

- 是数据在地理位置上更接近用户，从而降低访问延迟
- 当部分组件出现故障时，系统依然可以继续工作，从而提高可用性
- 扩展至多台机器以同时提供数据访问服务，从而提高读吞吐量

## 5.4 数据复制常用方法

### 5.4.1 主从复制

**原理**：主副本把数据写入本地存储后，然后将数据更改作为复制的日志或更改流发送给所有的从副本。每个从副本获得更改日志后将其应用到本地，**且<font color="red">严格保持与主副本相同的写入顺序</font>**。

#### 基于语句的复制

主节点记录所执行的每个写请求（操作语句）并将该操作语句作为日志发送给从节点。这种复制方式在有些场景下并不适合。比如：

1. 任何调用非确定性函数的语句。比如NOW()获取当前时间或RAND()获取一个随机数，可能在不通的副本上产生不同的值。
2. 有副作用的语句（存储过程、触发器等），可能会在每个副本上产生不同的副作用。

#### 基于预写日志（WAL）传输

日志描述的数据结果非常底层，使得复制方案与存储引擎紧密耦合。

#### 基于行的逻辑日志复制

复制与存储引擎采用不同的日志格式，复制与存储逻辑分离。这种复制日志称为逻辑日志。关系数据库的逻辑日志通常指一系列记录来描述数据表行级别的写请求。

MySQL的binlog（当配置为基于行的复制时）使用该方式。

#### 基于触发器的复制

基于触发器的复制通常比其它复制方式开销更高，也比数据库内置复制更容易出错。然后，它的灵活性较高。

### 5.4.2 多主节点复制

### 5.4.3 无主节点复制

## 数据复制方式

### 5.5.1 同步复制

优点：主节点故障，总是可以从从节点继续访问最新的数据。

缺点：从节点无法完成确认（例如从节点崩溃、网络故障等）写入就不能视为成功。主节点会阻塞后续所有的写操作，直到同步副本确认完成。

### 5.5.2 半同步复制

把所有从节点都配置为同步复制有些不切实际。因为任何一个同步节点的终端都会导致整个系统更新停止。实践中，如果数据库启用了同步复制，**通常意味着其中某一个从节点是同步的，而其他节点则是异步模式**。这样可以保证至少有两个节点拥有最新的数据副本。这种配置有时也称为**半同步**。

### 5.5.3 异步复制

优点：系统的吞吐性能更好。

缺点：如果主节点发生失败且不可恢复，则所有尚复制到从节点的写请求都会丢失。这意味着即使向客户端确认了写操作，却无法保证数据的持久化。

## 5.6 数据复制中有哪些挑战或者难点

### 1、所有副本之间的数据一致性问题

### 2、复制滞后问题

#### 读写一致性（写后读一致）问题

#### 单调读一致性问题

当读取数据时，单调读保证，如果某个用户依次进行多次读取，则他绝不会看到回滚现象，即在读取较新值之后又发生读取旧值的情况。实现单调读的一种方式是，确保每个用户总是从固定的同一个副本读取。

#### 前缀一致读

对于一系列按照某个顺序发生的写请求，那么读取这些内容时也会按照当时写入的顺序。这是分区数据库经常出现的一个问题。

#### 复制滞后的解决方案

通过应用层代码可以提供更强的一致性保证，但是需要在应用层增加额外的代码进行处理。

分布式事务也是一种选择。

### 3、新加入的从节点与主节点的数据一致性问题

1. 在某个时间点对主节点的数据副本产生一个一致性快照，这样避免长时间锁定整个数据库。
2. 将此快照拷贝到从节点。
3. 从节点连接到主节点并请求快照点之后所发生的数据更改日志。因为在步骤1创建快照时，快照与系统复制日志的某个确定位置相关联，这个位置信息在不同的系统有不同的称呼，如PostgreSQL称为日志序列号（log sequence number），MySQL称为binlog coordinates。
4. 获得日志后，从节点来应用这些快照之后所有数据变更，这个过程称之为**追赶**。接下来，它可以继续处理主节点上新的数据变化。

### 4、[节点失效问题](#节点失效问题)

问题描述：系统中的任何节点都可能因故障或者计划内的维护（例如重启节点以安装内核安全补丁）而导致中断甚至停机。

#### 4.1、[从节点失效](#从节点失效)

**追赶式恢复**

从节点磁盘上都保存了副本收到的数据变更日志。如果从节点发生崩溃，然后顺利重启，或者主从节点之间的网络发生暂时中断（闪断），则恢复比较容易，**根据副本的复制日志，从节点可以知道在发生故障之前所处理的最后一笔事务，然后连接到主节点，并请求自那笔事务之后中断期间内所有的数据变更**。在收到这些数据变更日志之后，将其应用到本地来追赶主节点。之后就和正常情况一样持续接收来自主节点数据流的变化。

#### 4.2、[主节点失效](#主节点失效)

主节点失效，选择某个从节点将其提升为主节点；客户端也需要更新，这样之后的写请求会发送给新的主节点，然后其它从节点要接受来自新的主节点上的数据变更，这一过程称为切换。

节点切换可以手动，也可以自动。自动切换的通常步骤为：

1. 确认主节点失效。大多数系统采用基于超时的机制来确认主节点失效，比如zk、dubbo等
2. 选举新的主节点。选主问题是一个典型的**共识问题**。
3. 使主节点生效。可能存在**脑裂**的情况。





