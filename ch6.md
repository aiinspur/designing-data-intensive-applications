# 第6章 数据分区

[TOC]



# 名次解释

分区也称为分片。

Cassandra 卡珊德拉

# 什么是分区

定义：每一条数据（或者记录，每行或每个文档）只属于某个特定分区。

分区的主要目标：将数据和查询负载**均匀分布**在所有节点上。

# 为什么要分区

数据分区的主要目的是**提高可扩展性**。不同的分区放在不通的节点（或者服务器）上。这样一个大数据集可以分散在更多的磁盘上，查询负载也随之分布到更多的处理器上。

对单个分区进行查询时，每个节点对自己所在分区可以独立执行查询操作，因此增加**更多的节点可以提高查询吞吐量**。

超大而复杂的查询比较困难，但也可能做到夸节点的并行处理。<font color="red">【如何做到？】</font>

# 数据库分区的历史

分区数据库最初在20世纪80年代由Teradata和Tandem NonStop SQL等率先推出，最近又被一些NoSQL数据库和基于Hadoop的数据仓库重视起来。

# 数据分区的方法（基于k-v数据模型）

## key-value数据的分区

如果分区不均匀，则会出现某些分区节点比其它分区承担更多的数据量或查询负载，称之为倾斜。

负载严重不成比例的分区即称为系统热点。避免热点最简单的方法是将记录随机分配给所有的节点。

均匀分布数据有一个大的缺点：当试图读取特定数据时，没有办法知道数据保存在哪个节点上，所以不得不并行查询所有节点。

## 基于关键字区间分区

为每个分区分配一段连续的关键字或者关键字区间范围。

关键字的区间段不一定非要均匀分布，分区边界应适配数据本身的分布特征。

采用基于关键字分区策略的系统包括：Bigtable、Bigtable的开源版本HBase、RethinkDB和2.4版本之前的MongoDB。

基于关键字的区间分区的缺点是某些访问模式会导致热点。举例说明，如果关键字是时间戳，则分区对应与一个时间范围，例如每天一个分区。然而，当数据写入时，所有的写入操作都集中在一个分区，这会导致该分区在写入时负载过高，而其它分区始终处于空闲状态。为了避免该问题，可以使用时间戳以外的其它内容作为关键字的第一项。

## 基于关键字哈希值分区

许多分布式系统采用基于关键字哈希函数的方式来分区。一个好的哈希函数可以处理数据倾斜并使其均匀分布。

采用关键字哈希进行分区，我们就丧失了良好的区间查询特性。

基于哈希的分区方法可以减轻热点，但无法做到完全避免。遇到一些高度倾斜的负载场景，只能通过应用层来减轻倾斜程度。

# 数据索引对分区的影响（对二级索引分区）

二级索引通常不能唯一标识一条记录，而是用来加速特定值的查询，例如查找用户123的所有操作，找到所有包含hogwash的文章，查找所有颜色为红色的汽车等。

二级索引是关系数据库的必备特性，在文档数据库中应用也非常普遍。但考虑其复杂性，许多k-v存储（如HBase和Voldemort）并不支持二级索引；此外，二级索引也是Slor、ES等全文索引服务器存在之根本。

二级索引带来的主要挑战是他们不能规整地映射到分区中。有两种主要的方法来支持二级索引进行分区：基于文档的分区和基于此条的分区。

## 基于文档分区的二级索引

在该索引方法中，每个分区完全独立，各自维护各自的二级索引，且只负责自己分区内的文档而不关心其它分区中的数据。每当需要写数据库时，包括添加、删除或更新文档等，只需要处理包含目标文档ID的那一个分区。因此文档分区索引也被称为本地索引，而不是全局索引。

读取时，需要将查询发送到所有的分区，然后合并所返回的结果。这种查询分区数据库的方法有时也称为分散/聚集，显然这种查询代价高昂。即使采用了并行查询，也容易导致读延迟显著放大。尽管如此，它还是广泛用于实践：MongoDB、Riak、Cassandra（卡珊德拉）、Elasticsearch、SolrCloud、VoltDB都支持基于文档分区二级索引。

## 基于词条的二级索引分区

在该方法中，我们可以对所有的数据构建全局索引。为了避免称为瓶颈，不能将全局索引存储在一个节点上，否则就破坏了设计分区的目标。全局索引也必须进行分区，且可以与数据关键字采用不同的分区策略。

词条分区，以待查找的关键字本身作为索引。直接分区的好处是可以支持高效的区间查询。

全局的词条分区的主要优点是：读取更为高效，客户端只需要向包含词条的那个分区发出读请求。全局索引的不利之处在于，写入速度较慢且非常复杂，单个文档的更新时，里面可能会涉及多个二级索引，而二级索引的分区又可能完全不同甚至在不同的节点上，势必引入显著的写放大。

实践中，全局二级索引的更新往往都是异步的。

# 分区再平衡

## 什么是分区再平衡

随着时间的推移，数据库可能总会出现某些变化：

- 查询压力增加，需要更多的CPU来处理负载
- 数据规模增加，需要更多的磁盘和内存来存储数据
- 节点可能故障，需要其它机器来接管失效的节点

所有这些变化都要求数据和请求可以从一个节点转移到另一个节点。这样一个迁移负载的过程称为再平衡（或者动态平衡）。无论哪种分区方案，分区再平衡通常至少需要满足：

- 平衡之后，负载、数据存储、读写请求等应该在集群范围更均匀地分布
- 再平衡执行过程中，数据库应该可以继续正常提供读写服务
- 避免不必要的负载迁移，以加快再平衡，并尽量减少网络和磁盘I/O影响

## 分区再平衡的策略

### 策略一：不用取模mod

对节点数取模方法的问题是，如果节点数N发生了变化，**会导致很多关键字需要从现有的节点迁移到另一个节点**。频繁的迁移操作大大增加了再平衡的成本。

### 策略二：固定数量的分区

创建远超于实际节点数的分区数，然后为每个节点分配多个分区。比如，对于一个10节点的集群，数据库可以从一开始就逻辑划分1000个分区，这样大约每个节点承担

# 请求路由到分区并查询