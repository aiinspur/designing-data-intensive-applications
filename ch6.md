# 第6章 数据分区

[TOC]



# 名次解释

分区也称为分片。

Cassandra 卡珊德拉

# 什么是分区

定义：每一条数据（或者记录，每行或每个文档）只属于某个特定分区。

分区的主要目标：将数据和查询负载**均匀分布**在所有节点上。

# 为什么要分区

数据分区的主要目的是**提高可扩展性**。不同的分区放在不通的节点（或者服务器）上。这样一个大数据集可以分散在更多的磁盘上，查询负载也随之分布到更多的处理器上。

对单个分区进行查询时，每个节点对自己所在分区可以独立执行查询操作，因此增加**更多的节点可以提高查询吞吐量**。

超大而复杂的查询比较困难，但也可能做到夸节点的并行处理。<font color="red">【如何做到？】</font>

# 数据库分区的历史

分区数据库最初在20世纪80年代由Teradata和Tandem NonStop SQL等率先推出，最近又被一些NoSQL数据库和基于Hadoop的数据仓库重视起来。

# 数据分区的方法

## key-value数据的分区

如果分区不均匀，则会出现某些分区节点比其它分区承担更多的数据量或查询负载，称之为倾斜。

负载严重不成比例的分区即称为系统热点。避免热点最简单的方法是将记录随机分配给所有的节点。

均匀分布数据有一个大的缺点：当试图读取特定数据时，没有办法知道数据保存在哪个节点上，所以不得不并行查询所有节点。

## 基于关键字区间分区

为每个分区分配一段连续的关键字或者关键字区间范围。

关键字的区间段不一定非要均匀分布，分区边界应适配数据本身的分布特征。

采用基于关键字分区策略的系统包括：Bigtable、Bigtable的开源版本HBase、RethinkDB和2.4版本之前的MongoDB。

基于关键字的区间分区的缺点是某些访问模式会导致热点。举例说明，如果关键字是时间戳，则分区对应与一个时间范围，例如每天一个分区。然而，当数据写入时，所有的写入操作都集中在一个分区，这会导致该分区在写入时负载过高，而其它分区始终处于空闲状态。为了避免该问题，可以使用时间戳以外的其它内容作为关键字的第一项。

## 基于关键字哈希值分区

许多分布式系统采用基于关键字哈希函数的方式来分区。一个好的哈希函数可以处理数据倾斜并使其均匀分布。

采用关键字哈希进行分区，我们就丧失了良好的区间查询特性。

基于哈希的分区方法可以减轻热点，但无法做到完全避免。遇到一些高度倾斜的负载场景，只能通过应用层来减轻倾斜程度。

# 数据索引对分区的影响



# 分区再平衡

# 请求路由到分区并查询