# 第11章 流处理系统

[TOC]

一般来说，流是指随着时间的推移而持续可用的数据。



## 消息系统

### 生产者与消费者之间直接传递消息

- UDP组广播
- 无代理消息库（如ZeroMQ）
- HTTP或者RPC请求

### 消息代理

#### 消息代理如数据库对比

#### 多个消费者

#### 确认和重新传递

#### 基于日志的消息存储

日志是磁盘上一个仅支持追加式修改记录的序列。

生产者通过将消息追加到日志的末尾来发送消息，消费者通过依次读取日志来接收消息。如果消费者读到日志的末尾，它就开始等待新消息被追加的通知。

为了突破单个磁盘所能提供的带宽吞吐的上限，可以对日志进行分区。不同的节点负责不同的分区，使每个分区成为一个单独的日志，并且可以独立于其它分区读取和写入。然后可以将主题定义为一组分区，它们都携带相同类型的消息。

生产者通过将消息追加到基于主题-分区的文件，消费者一次读取这些文件。

#### 对比日志与传统消息系统

#### 消费者偏移量

顺序读取一个分区可以很容易的判断哪些消息已经被处理：所有偏移量小于消费者当前偏移量的消息已经被处理。并且所有更大偏移量的消息还没有消费。因此，代理不需要跟踪每条消息的确认，只需要定期记录消费者的偏移量。

如果消费者节点失败，则消费者组中的另一个节点将被分配到失败的消息者分区，并以最后记录的偏移量开始使用消息。如果消费者已经处理了后续的消息，但还没有记录它们的偏移量，那么在重新启动后这些消息将被再次处理。

#### 磁盘空间使用

如果持续不断的追加日志，磁盘空间最终将被耗尽。为了回收磁盘空间，日志实际上是被分割成段，并且不时地将旧段删除或归档保存。

如果一个消费者的速度慢到难以跟上消息生产的速度，并且远远落后以至于消费者偏移量指向了已经被删除的片段，那么消费者将会错过一些消息。实际上日志实现了一个有限大小的缓冲区，当缓冲区满时，旧的消息就被丢弃，该缓冲区也被称为循环缓冲区或环形缓冲区。由于该缓冲区在磁盘上，因此它可以非常大。

#### 当消费者跟不上生产者时

- 丢弃消息
- 将消息缓冲在队列中
- 激活背压即流量控制（组织生产者发送更多的消息）

#### 重新处理信息

## 数据库与流

### 保持系统同步

- 批量同步更新
- 双重写入：程序代码在数据更改时显示的写入每个系统。例如，首先写入数据库，然后更新搜索索引，然后使缓存条目失效。双重写入存在严重的问题，比如：竞争条件问题；一个写入失败，另一个写入成功；

### 变更数据的捕获（Change Data Capture，CDC）

#### 实现变更数据的捕获

从本质上讲，变更数据捕获使得一个数据库称为主节点，将其他（如搜索索引、数据仓库等）变成从节点。由于基于日志的消息代理保留了消息的排序，因此它非常适合从源数据库传输更改事件（避免了重新排序的问题）。

数据触发器也可以用来实现变更数据的捕获，但是它们往往不太稳定，并且有着非常大的性能开销。

#### 初始快照

如果有了数据库所有更改的日志，就可以通过replay日志来重建数据库的整个状态。然而，在许多情况下，永久保留所有的更改将会需要太多的磁盘空间，并且replay将花费太长时间，因此日志需要被截断。

例如，构建新的全文检索系统需要整个数据库的完整副本，仅有应用最近变更的日志还不够，因为它会丢失最近未更新的数据。因此，如果没有完整的日志历史记录，则需要从一致性的快照开始。

数据库的快照必须与更改日志中的已知的未知或偏移量对应，以便在快照处理完成后，知道在哪一点开始应用更改。

#### 日志压缩

